!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("rdflib"),require("http-link-header"),require("rdf-namespaces")):"function"==typeof define&&define.amd?define(["exports","rdflib","http-link-header","rdf-namespaces"],t):t((e=e||self).Tripledoc={},e.rdflib,e.LinkHeader,e.rdfNamespaces)}(this,function(e,t,n,r){"use strict";function u(e,t,n,r){return new(n||(n=Promise))(function(u,i){function o(e){try{a(r.next(e))}catch(e){i(e)}}function f(e){try{a(r.throw(e))}catch(e){i(e)}}function a(e){e.done?u(e.value):new n(function(t){t(e.value)}).then(o,f)}a((r=r.apply(e,t||[])).next())})}function i(e,t){var n,r,u,i,o={label:0,sent:function(){if(1&u[0])throw u[1];return u[1]},trys:[],ops:[]};return i={next:f(0),throw:f(1),return:f(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function f(i){return function(f){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(u=2&i[0]?r.return:i[0]?r.throw||((u=r.return)&&u.call(r),0):r.next)&&!(u=u.call(r,i[1])).done)return u;switch(r=0,u&&(i=[2&i[0],u.value]),i[0]){case 0:case 1:u=i;break;case 4:return o.label++,{value:i[1],done:!1};case 5:o.label++,r=i[1],i=[0];continue;case 7:i=o.ops.pop(),o.trys.pop();continue;default:if(!(u=(u=o.trys).length>0&&u[u.length-1])&&(6===i[0]||2===i[0])){o=0;continue}if(3===i[0]&&(!u||i[1]>u[0]&&i[1]<u[3])){o.label=i[1];break}if(6===i[0]&&o.label<u[1]){o.label=u[1],u=i;break}if(u&&o.label<u[2]){o.label=u[2],o.ops.push(i);break}u[2]&&o.ops.pop(),o.trys.pop();continue}i=t.call(e,o)}catch(e){i=[6,e],r=0}finally{n=u=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,f])}}}n=n&&n.hasOwnProperty("default")?n.default:n;var o=$rdf.graph(),f=new $rdf.Fetcher(o,void 0),a=new $rdf.UpdateManager(o);function c(){return o}function l(){return f}function s(){return a}function d(e,t){return new Promise(function(n,r){s().update(e,t,function(e,t,u){return t?n():r(new Error(u))})})}function p(e,t){return new Promise(function(n,r){var u=c(),i=s(),o=u.sym(e);i.put(o,t,"text/turtle",function(e,t,u,i){return t?n(i):r(new Error(u))})})}var m=function(e,t,n,r){return function(e,t,n,r,u,i){var o=e.find(function(e){return void 0!==e[t]&&b(e,n,r,u,i)});return void 0!==o?R(o[t]):null}(e,"subject",null,t,n,r)},v=function(e,t,n,r){return y(e,"subject",null,t,n,r)},g=function(e,t,n,r){return y(e,"object",t,n,null,r)};function y(e,t,n,r,u,i){return e.filter(function(e){return void 0!==e[t]&&b(e,n,r,u,i)}).map(function(e){return R(e[t])}).filter(S)}function h(e,t,n,r,u){return e.filter(function(e){return b(e,t,n,r,u)})}function b(e,t,n,r,u){var i=t?w(t):null,o=n?w(n):null,f=r?w(r):null,a=$rdf.sym(u);return(null===i||e.subject.sameTerm(i))&&(null===o||e.predicate.sameTerm(o))&&(null===f||e.object.sameTerm(f))&&(null===a||void 0!==e.why&&L(e.why)&&e.why.sameTerm(a))}function w(e){return"string"==typeof e?$rdf.sym(e):e}function R(e){return"BlankNode"===e.termType?e:L(e)?e.uri:O(e)?e:null}function S(e){return null!==e}function L(e){return"NamedNode"===e.termType}function T(e,t){var n=H(t)?t:$rdf.sym(t),u=h(e.getStatements(),t,null,null,e.asRef()),i=[],o=[],f=function(n){return g(u,t,n,e.asRef())},a=function(e){var t=f(e).find(E);return void 0===t?null:t},c=function(e){return f(e).filter(E)},l=function(t,r){i.push($rdf.st(n,$rdf.sym(t),N(r),$rdf.sym(e.asRef())))},s=function(t,r){i.push($rdf.st(n,$rdf.sym(t),$rdf.sym(r),$rdf.sym(e.asRef())))},d=function(t,r){o.push($rdf.st(n,$rdf.sym(t),$rdf.sym(r),$rdf.sym(e.asRef())))},p=function(n){o.push.apply(o,h(u,t,n,null,e.asRef()))},m=function(e,t){p(e),s(e,t)},v=function(){return H(t)?t.id:t};return{getDocument:function(){return e},getStatements:function(){return u},getString:function(e){var t=f(e).find(C);return void 0===t?null:t.value},getInteger:function(e){var t=f(e).find(F);return void 0===t?null:j(t)},getDecimal:function(e){var t=f(e).find(X);return void 0===t?null:k(t)},getDateTime:function(e){var t=f(e).find(q);return void 0===t?null:$(t)},getLiteral:function(e){var t=f(e).find(O);return void 0===t?null:D(t)},getAllStrings:function(e){return f(e).filter(C).map(x)},getAllIntegers:function(e){return f(e).filter(F).map(j)},getAllDecimals:function(e){return f(e).filter(X).map(k)},getAllDateTimes:function(e){return f(e).filter(q).map($)},getAllLiterals:function(e){return f(e).filter(O).map(D)},getLocalSubject:function(t){var n=f(t).find(H);return void 0===n?null:T(e,n)},getAllLocalSubjects:function(t){return f(t).filter(H).map(function(t){return T(e,t)})},getRef:a,getAllRefs:c,getType:function(){return a(r.rdf.type)},addLiteral:l,addRef:s,removeAll:p,removeLiteral:function(t,r){o.push($rdf.st(n,$rdf.sym(t),N(r),$rdf.sym(e.asRef())))},removeRef:d,setLiteral:function(e,t){p(e),l(e,t)},setRef:m,clear:function(){o.push.apply(o,u)},getPendingStatements:function(){return[o,i]},asRef:v,getNodeRef:a,getAllNodeRefs:c,addNodeRef:s,removeNodeRef:d,setNodeRef:m,asNodeRef:v}}function $(e){var t=parseInt(e.value.substring(0,4),10),n=parseInt(e.value.substring(5,7),10)-1,r=parseInt(e.value.substring(8,10),10),u=parseInt(e.value.substring(11,13),10),i=parseInt(e.value.substring(14,16),10),o=parseInt(e.value.substring(17,e.value.indexOf("Z")),10),f=new Date(0);return f.setUTCFullYear(t),f.setUTCMonth(n),f.setUTCDate(r),f.setUTCHours(u),f.setUTCMinutes(i),f.setUTCSeconds(o),f}function j(e){return parseInt(e.value,10)}function k(e){return parseFloat(e.value)}function x(e){return e.value}function D(e){return q(e)?$(e):F(e)?j(e):X(e)?k(e):e.value}function N(e){return e instanceof Date?$rdf.Literal.fromDate(e):"number"==typeof e?$rdf.Literal.fromNumber(e):new $rdf.Literal(e,void 0,void 0)}function P(e,t){var r,u=e.headers.get("Link");if(u&&n){var i=n.parse(u).get("rel","acl");1===i.length&&(r=new URL(i[0].uri,t).href)}return r}function U(e,t){var n=this,o=new URL(e),f=o.origin+o.pathname+o.search,a=c().statementsMatching(null,null,null,$rdf.sym(f)),l=function(){return f},s=function(){return t.aclRef||null},g={},y=function(e){return g[e]||(g[e]=T(b,e)),g[e]},h=function(e,t){return I(v,f,a)(e,t).filter(E).map(y)},b={addSubject:function(e){var t=void 0===e?{}:e,n=t.identifier,r=void 0===n?M():n,u=t.identifierPrefix;return y(f+"#"+(void 0===u?"":u)+r)},removeSubject:function(e){return y(e).clear()},getSubject:y,getSubjectsOfType:function(e){return h(r.rdf.type,e)},findSubject:function(e,t){var n=A(m,f,a)(e,t);return n&&E(n)?y(n):null},findSubjects:h,getAclRef:s,getWebSocketRef:function(){return t.webSocketRef||null},asRef:l,save:function(e){return void 0===e&&(e=Object.values(g)),u(n,void 0,void 0,function(){var n,r,u,o,a,c,l;return i(this,function(i){switch(i.label){case 0:return n=e.filter(function(e){return e.getDocument().asRef()===f}),r=n.reduce(function(e,t){var n=e[0],r=e[1],u=t.getPendingStatements(),i=u[0],o=u[1];return[n.concat(i),r.concat(o)]},[[],[]]),u=r[0],o=r[1],t.existsOnPod?[3,2]:[4,p(f,o)];case 1:return a=i.sent(),(c=P(a,f))&&(t.aclRef=c),(l=a.headers.get("Updates-Via"))&&(t.webSocketRef=l),t.existsOnPod=!0,[3,4];case 2:return[4,d(u,o)];case 3:i.sent(),i.label=4;case 4:return[2,U(f,t)]}})})},getStatements:function(){return a},asNodeRef:l,getAcl:s};return b}var A=function(e,t,n){return function(r,u){return e(n,r,u,t)}},I=function(e,t,n){return function(r,u){return e(n,r,u,t)}},M=function(){return Date.now().toString()+Math.random().toString().substring("0.".length)};function O(e){return"object"==typeof e&&null!==e&&"string"==typeof e.termType&&"Literal"===e.termType}function C(e){return O(e)&&"http://www.w3.org/2001/XMLSchema#string"===e.datatype.uri}function F(e){return O(e)&&"http://www.w3.org/2001/XMLSchema#integer"===e.datatype.uri}function X(e){return O(e)&&"http://www.w3.org/2001/XMLSchema#decimal"===e.datatype.uri}function q(e){return O(e)&&"http://www.w3.org/2001/XMLSchema#dateTime"===e.datatype.uri}var B=E;function E(e){return"string"==typeof e&&!O(e)}function H(e){return"object"==typeof e&&null!==e&&"string"==typeof e.termType&&"BlankNode"===e.termType}e.create=p,e.createDocument=function(e){return U(e,{existsOnPod:!1})},e.fetchDocument=function(e){return u(this,void 0,void 0,function(){var t,n,r;return i(this,function(u){switch(u.label){case 0:return[4,l().load(e)];case 1:return t=u.sent(),n=P(t,e),r=t.headers.get("Updates-Via"),[2,U(e,{aclRef:n,webSocketRef:r||void 0,existsOnPod:!0})]}})})},e.getFetcher=l,e.getStore=c,e.getUpdater=s,e.initialiseSubject=T,e.isBlankNode=H,e.isDateTimeLiteral=q,e.isDecimalLiteral=X,e.isIntegerLiteral=F,e.isLiteral=O,e.isNodeRef=B,e.isReference=E,e.isStringLiteral=C,e.update=d,Object.defineProperty(e,"__esModule",{value:!0})});